YUI.add("manage-wskeys-view",function(d){var b=d.Lang,c,a=d.WKM.Templates,e="manage-wskeys-view";d.namespace("WKM").ManageWSKeysView=c=d.Base.create(e,d.WKM.BaseView,[],{_template:a[e],events:{".add-inst-btn":{click:"_onClickAddInstBtn"},".navigateToKey":{click:"_navigateToKeyDetails"},".reissueKey":{click:"_reissueKeyDialog"},".showQuotasButton":{click:"_quotaPopup"},".hideQuotasButton":{click:"_hideQuotas"},"select":{change:"_onChangeDropdown"}},USER_TYPE_ELDAP:"ELDAP",_userInfo:null,_datatable:null,_wskeyInfoList:null,_filterAllText:null,_serviceList:null,_removedItems:null,_app:null,_appStrings:null,_instId:null,_quotaTable:null,initializer:function(g){var f=this.get("container"),n=this.get("strings"),o=this,m,h;this._app=g.app;this._appStrings=g.appStrings;this._userInfo=g.userInfo;if(g.wskeyList){this._wskeyInfoList=g.wskeyList;}else{this._wskeyInfoList=new d.WKM.WSKeyList();}this._filterAllText=n.label.filter.all;this._removedItems=[];if(g.serviceList){this._serviceList=g.serviceList;}else{this._serviceList=new d.WKM.WSKeyServiceList();}var j=this._userInfo.get("userType");var k=false;if(j===this.USER_TYPE_ELDAP){k=true;}var l=[{label:n.label.name,key:"name",allowHTML:true,formatter:function(p){p.className+="navigateToKey";return"<a href='#'>"+p.value+"</a>";}},{label:n.label.services,key:"services",allowHTML:true,formatter:function(p){return o._formatServices(p.value);},sortFn:function(q,p){return o._sortServices(q,p);}},{label:n.label.key,key:"id",allowHTML:true,formatter:function(p){p.className+="navigateToKey";return"<a href='#' >"+p.value.substring(0,35)+"...</a>";}},{label:n.label.expires,key:"expirationDate",formatter:function(p){return p.value&&d.Date.format(new Date(parseInt(p.value)),{format:"%m/%d/%Y"});},emptyCellValue:"(unknown)"},{label:n.label.registryid,key:"params",formatter:function(p){return p.value["registryId"]?p.value["registryId"][0]:"";}},{label:n.label.oclcSymbol,key:"oclcSymbol"},{label:n.label.environment,key:"type"},{label:n.label.usageBlocked,key:"quotaExceeded"},{label:n.label.createdDate,key:"createdDate",formatter:function(p){return p.value&&d.Date.format(new Date(parseInt(p.value)),{format:"%m/%d/%Y"});}}];var i={label:n.label.reissue,key:"reissueFlag",allowHTML:true,formatter:function(q){var p=q.data.id;if(q.value){return"<a href='#' class='reissueKey' data-wskey='"+p+"'>"+n.label.reissue+"</a>";}else{return"";}}};if(!k){console.log("adding reissue column to config");l.push(i);}this._datatable=new d.DataTable({columns:l,sortBy:{createdDate:"desc"},data:this._wskeyInfoList});},destructor:function(){var f=(new d.EventHandle(this._eventHandles)).detach();if(this._datatable){this._datatable.destroy();}},_formatServices:function(i){var h="",f,g=this;i.each(function(j){f=g._serviceList.getById(j.get("name"));if(f){h=h+",<br>"+f.get("displayName")+"&nbsp;("+j.get("name")+")";}else{h=h+",<br>Unknown&nbsp;("+j.get("name")+")";}});return h.substring(5);},_sortServices:function(h,g){var i=h.get("services").isEmpty()?"":h.get("services").item(0).get("name"),k=g.get("services").isEmpty()?"":g.get("services").item(0).get("name"),f=this._serviceList.getById(i),m=this._serviceList.getById(k),l=f?f.get("displayName").toLowerCase():"",j=m?m.get("displayName").toLowerCase():"";return(l===j)?0:(l>j)?1:-1;},render:function(){var f=this.get("container"),p=this.get("strings"),q=this,n,g,j,o=this._userInfo.get("institutions"),h=this._userInfo.get("userType");this.set("pageHeading",p.heading);this.set("pageTitle",p.heading);if(!f.inDoc()){f.addClass(this.getClassName("container"));f.append(this._template({strings:p}));this._datatable.render(f.one(".dt"));}this._app.fillInstDropDown(f,o,h);var l=[];for(var j=0;j<this._wskeyInfoList.size();j++){var k=this._wskeyInfoList.item(j);var m=k.getAttrs().params.registryId;if(m&&m[0]){l.push(m[0]);}}l=l.filter(function(t,s,r){return r.indexOf(t)===s;});n=f.getDOMNode().getElementsByTagName("select")[1];for(j=0;j<l.length;j++){g=document.createElement("option");g.innerHTML=l[j];n.appendChild(g);}this._filter();return this;},_quotaPopup:function(){if(!this._instId){var f=document.getElementById("instSelect");var g=f.options[f.selectedIndex].value;if(g){this._instId=g;}else{return null;}}var o=false;var q=this.get("strings").label.quotaCallError;var v=null;$.ajax({"url":"/wskey/quotaSearch?clientId="+this._instId+"&clientIdType=institution_by_wskey","method":"GET","contentType":"application/json","async":false,error:function(){o=true;}}).done(function(i){v=i;});if(!v){document.getElementById("instQuotaNone").removeAttribute("hidden");}else{document.getElementById("instQuota").removeAttribute("hidden");var s=document.getElementById("usageCount");s.removeAttribute("hidden");s.innerText=this.get("strings").label.apiUsageColon+v.usageCount;if(v.quotaLimitType==="hard"){var x=document.getElementById("instQuotaExceeded");x.removeAttribute("hidden");x.innerText=this.get("strings").label.quotaExceededColon+v.quotaExceeded;}}var n=[];var r=[];if(this._wskeyInfoList&&this._wskeyInfoList.item(0)){n=this._wskeyInfoList.item(0).lists[0].get("id");r=this._wskeyInfoList.item(0).lists[0].get("quotaExceeded");}var u={};var j=0;for(j;j<n.length;j++){u[n[j]]=r[j];}var h=[];var t=[];var m=0;for(m;m<n.length;m++){var p=n[m];var l=$.ajax({"url":"/wskey/quotaSearch?clientId="+p+"&clientIdType=wskey","method":"GET","contentType":"application/json",error:function(){o=true;}}).done(function(i){if(i){i.quotaExceeded=u[i.clientIdentifier];if(i.quotaLimitType==="hard"){h.push(i);}}});t.push(l);}if(!o){var w=this.get("strings").label.quotaExceeded;$.when.apply(null,t).done(function(){this._quotaTable=$("#quotaTable").dataTable({"aaData":h,"searching":false,"paging":false,"destroy":true,"stripeClasses":["yui3-datatable-odd","yui3-datatable-even"],"columns":[{"data":"clientIdentifier"},{"data":"quotaExceeded","render":function(i){if(i===true){return w;}else{return"";}}},{"data":"usageCount"}]});});document.getElementById("quotaDisplay").removeAttribute("hidden");document.getElementById("showQuotasButton").setAttribute("hidden","true");
document.getElementById("hideQuotasButton").removeAttribute("hidden");}else{alert(q);}},_hideQuotas:function(f){document.getElementById("instQuotaNone").setAttribute("hidden","true");document.getElementById("instQuota").setAttribute("hidden","true");document.getElementById("instQuotaExceeded").setAttribute("hidden","true");document.getElementById("usageCount").setAttribute("hidden","true");document.getElementById("quotaDisplay").setAttribute("hidden","true");document.getElementById("showQuotasButton").removeAttribute("hidden");document.getElementById("hideQuotasButton").setAttribute("hidden","true");},_onClickAddInstBtn:function(h){var f=this.get("container"),g=this;this._app.addInstToDropDown(f,function(){g._onChangeInstDropdown();});},_navigateToKeyDetails:function(h){var f=h.target.ancestor("tr").getAttribute("data-yui3-record"),g=this._wskeyInfoList.getByClientId(f);d.fire("manage-wskey",{id:g.get("id")});},_reissueKeyDialog:function(i){var h=i.target.getAttribute("data-wskey");var f=this.get("strings");var j=d.Node.create("<div>"+f.label.reissueDialogText+" <br/>"+"<select id='reissueDurationUntilInactive'>"+"<option id='60' value='60'>60</option>"+"<option id='duration30' value='30'>30</option>"+"<option value='14'>14</option>"+"<option value='7'>7</option>"+"<option value='3'>3</option>"+"<option value='1'>1</option>"+"<option value='0'>0</option>"+"</select>"+"</div>");var g=new d.Panel({contentBox:d.Node.create("<div id='reissueWSKey' class='message icon-warn' data-wskey='"+h+"'/>"),bodyContent:j,width:400,centered:true,modal:true,headerContent:"Reissue WSKey",buttons:{footer:[{name:"cancel",label:f.label.cancel,action:"onCancel"},{name:"reissue",label:f.label.reissue,action:"onReissue"}]}});g.onCancel=function(k){k.preventDefault();this.hide();this.callback=false;};g.onReissue=function(m){var k=d.one("#reissueWSKey").getAttribute("data-wskey");var l=d.one("#reissueDurationUntilInactive");var n=l.get("value");d.io("/wskey/reissueWSKey?wskeyId="+k+"&duration="+n,{method:"GET",on:{success:function(q,o,p){g.reissueCompleteDialog("WSKey successfully reissued!  New WSKey is:<br/>"+o.responseText);},failure:function(q,o,p){g.reissueCompleteDialog("Error reissuing WSKey:"+o.statusText);}}});this.hide();};g.reissueCompleteDialog=function(k){var l=new d.Panel({contentBox:d.Node.create("<div id='reissueCompletedDialog' class='message icon-warn'/>"),bodyContent:k,width:400,centered:true,modal:true,headerContent:"Reissue Complete",buttons:{footer:[{name:"Close",label:f.label.closeDialog,action:"close"}]}});l.close=function(m){m.preventDefault();this.hide();this.callback=false;};l.render();};g.render();},_onChangeDropdown:function(f){switch(f.currentTarget.get("id")){case"instSelect":this._onChangeInstDropdown();break;case"regIDSelect":this._filter();break;case"statusSelect":this._filter();break;default:}},_onChangeInstDropdown:function(){var f,h=document.getElementById("instSelect");f=h.options[h.selectedIndex].value,oldWskeyInfoList=this._wskeyInfoList;newWskeyInfoList=new d.WKM.WSKeyInfoList(),app=this._app,appStrings=this._appStrings,container=this.get("container"),regIDList=[];this._instId=f;app.showWaiting(true);newWskeyInfoList.load({instId:f},function(p){app.showWaiting(false);if(p){console.log(p);console.log(JSON.stringify(p));app.showErrorAlert(appStrings.error.loadWSKeys);}else{oldWskeyInfoList.reset();for(var n=0;n<newWskeyInfoList.size();n++){var q=newWskeyInfoList.item(n);var k=q.getAttrs().params.registryId;if(k&&k[0]){regIDList.push(k[0]);}oldWskeyInfoList.add(q);}}var m=container.getDOMNode().getElementsByTagName("select")[1];while(m.options.length>0){m.remove(0);}var o=document.createElement("option");o.innerHTML="All";m.append(o);var l=document.createElement("option");l.innerHTML="No Registry ID";m.append(l);regIDList=regIDList.filter(function(t,s,r){return r.indexOf(t)===s;});for(n=0;n<regIDList.length;n++){var j=document.createElement("option");j.innerHTML=regIDList[n];m.appendChild(j);}});var g=document.getElementById("regIDSelect");g.selectedIndex=0;document.getElementById("statusSelect").selectedIndex=0;this._hideQuotas();},_filter:function(){while(this._removedItems.length>0){this._wskeyInfoList.add(this._removedItems.pop());}var f=document.getElementById("regIDSelect");var l=f!=null?f.options[f.selectedIndex].value:"All";if(l!==this._filterAllText){for(var k=0;k<this._wskeyInfoList.size();k++){var m=this._wskeyInfoList.item(k);var o=m.getAttrs().params.registryId?m.getAttrs().params.registryId[0]:"No Registry ID";if(o!==l){this._removedItems.push(m);this._wskeyInfoList.remove(k);k--;}}}var n=document.getElementById("statusSelect");var g=n!=null?n.options[n.selectedIndex].value:"VALID";switch(g){case"VALID":for(var h=0;h<this._wskeyInfoList.size();h++){var p=this._wskeyInfoList.item(h);if(!(p.getAttrs().status==="ACTIVE"&&Date.now()<p.getAttrs().expirationDate)){this._removedItems.push(p);this._wskeyInfoList.remove(h);h--;}}break;case"INVALID":for(var h=0;h<this._wskeyInfoList.size();h++){var p=this._wskeyInfoList.item(h);if(p.getAttrs().status!=="CANCELED"||Date.now()<p.getAttrs().expirationDate){this._removedItems.push(p);this._wskeyInfoList.remove(h);h--;}}break;default:break;}}},{ATTRS:{strings:{value:d.Intl.get(e)}}});},"@VERSION@",{requires:["base-view","datatable","datatable-sort","datatype-date","panel","io","node","wskey-model","wskeysecret-model","wskeyservice-model"],skinnable:true});
YUI.add("lang/manage-wskey-view",function(a){a.Intl.add("manage-wskey-view","",{"label":{"docLink":"View API Documentation","sandboxInfo":"Sandbox Info","resetSecret":"ResetSecret","services":"Services","status":"Status","corsDomain":"CORS Domains","override":"Override Institutions","secret":"Secret","key":"Key","registryid":"Registry ID","activateWskey":"Re-enable WSKey","copyKey":"Click on key to select it for copy","expiration":"Expiration Date","comments":"Registration Comments","environment":"Environment","redirecturi":"Redirect URI","copySecret":"Click on secret to select it for copy","blockWskey":"Block WSKey","save":"Save","oclcSymbol":"OCLC Symbol","name":"Name","actions":"Actions"},"error":{"secretFailure":"Error loading wskey secret","secretDenied":"Your account does not have access to view secret","blockWskeyDenied":"Your account does not have access to block wskey","activateWskeyDenied":"Your account does not have access to re-enable WSKey","resetSecretDenied":"Your account does not have access to reset secret","resetSecretFailure":"Error updating wskey secret","blockWskeySuccess":"Successfully cancelled key and revoked grants.","activateWskeySuccess":"Successfully re-enabled WSKey.","activateWskeyFailure":"Error updating wskey status to ACTIVE","blockWskeyFailure":"Error updating wskey status to CANCELED"},"heading":"WSKey"});},"@VERSION@");
YUI.add("wskeyinfo-model",function(b){b.namespace("WKM").WSKeyInfoModel=b.Base.create("wskeyinfo-model",b.Model,[b.Platform.ModelSync.REST],{root:"/keys"},{ATTRS:{status:{},user:{setter:function(d){var c=new b.WKM.UserModel(d);return c;}},createdDate:{},createdBy:{},oclcSymbol:{},expirationDate:{},updatedDate:{},updatedBy:{},params:{},services:{setter:function(d){var c=new b.WKM.ServiceList();c.add(d);c.comparator=function(e){return e.get("name").toLowerCase();};return c.sort();}},wskeyVersion:{},id:{},type:{},name:{}}});"use strict";var a;b.namespace("WKM").WSKeyInfoList=a=b.Base.create("wskeyinfo-list",b.ModelList,[b.Platform.ModelSync.REST],{model:b.WKM.WSKeyInfoModel,getURL:function(e,d){var c=b.Platform.ModelSync.REST.prototype.getURL.apply(this,arguments);if(d.instId){c=c+"?instId="+d.instId;}return c;},parse:function(c){var d=a.superclass.parse.apply(this,arguments);if(d.wskeys){return d.wskeys;}return d;}},{});"use strict";b.namespace("WKM").UserModel=b.Base.create("user-model",b.Model,[],{},{ATTRS:{name:{},realm:{}}});"use strict";b.namespace("WKM").ServiceModel=b.Base.create("service-model",b.Model,[],{},{ATTRS:{status:{},registeredDate:{},expirationDate:{},actions:{},name:{},isExpired:{}}});"use strict";var a;b.namespace("WKM").ServiceList=a=b.Base.create("service-list",b.ModelList,[],{model:b.WKM.ServiceModel},{});},"@VERSION@",{requires:["model","model-list","cop-modelsync-extension"],skinnable:false});
YUI.add("manage-wskey-view",function(d){var b=d.Lang,c,a=d.WKM.Templates,e="manage-wskey-view";d.namespace("WKM").ManageWSKeyView=c=d.Base.create(e,d.WKM.BaseView,[],{_template:a[e],events:{".save-btn":{click:"_onClickSaveBtn"},".resetSecret-btn":{click:"_onClickResetSecretBtn"},".blockWskey-btn":{click:"_onClickBlockWskeyBtn"},".activateWskey-btn":{click:"_onClickActivateWskeyBtn"},"#key, #secret":{click:"_hilightForCopy"},"#delete":{click:"_onClickDeleteParamBtn"},"#add":{click:"_onClickAddParamBtn"}},_wskeyInfo:null,_wskeyInfoList:null,_serviceList:null,_app:null,_redirectURICount:null,_corsDomainCount:null,initializer:function(h){var g=this.get("container"),f=this.get("strings");this._app=h.app;if(h.wskey){this._wskeyInfo=h.wskey;}else{this._wskeyInfo=new d.WKM.WSKeyByIdModel();}if(h.serviceList){this._serviceList=h.serviceList;}else{this._serviceList=new d.WKM.WSKeyServiceList();}this._wskeyInfoList=new d.WKM.WSKeyList();},destructor:function(){var f=(new d.EventHandle(this._eventHandles)).detach();},_formatServicesDetails:function(j){var i="",g,f=this.get("strings"),h=this;j.each(function(k){g=h._serviceList.getById(k.get("name"));if(g){i=i+"<span class='servicename'>"+g.get("displayName")+" ("+k.get("name")+")</span>";if(g.get("documentationLink")){i=i+"<a class='serviceitem' href='"+g.get("documentationLink")+"' target='_blank'>"+f.label.docLink+"</a>";}if(g.get("sandboxInfo")){i=i+"<span class='serviceitem'>"+f.label.sandboxInfo+": "+g.get("sandboxInfo")+"</span>";}}else{i=i+"<span class='servicename'>Unknown ("+k.get("name")+")</span>";}if(k.get("actions").length>0){i=i+"<span class='serviceitem'>"+f.label.actions+": "+k.get("actions").join(", ")+"</span>";}});return i;},_getServiceLevelParam:function(h,f){var g="";h.each(function(i){var j=i.get("wskeyParameters");if(j){if(j.wskeyParameters){if(f==j.wskeyParameter[0].name){g=j.wskeyParameter[0].value;}}}});return g;},render:function(){var s=this._app,w=this.get("container"),o=this.get("strings"),m=new d.WKM.WSKeySecretModel(),C;this.set("pageHeading",o.heading);this.set("pageTitle",o.heading);if(!w.inDoc()){w.addClass(this.getClassName("container"));w.append(this._template({strings:o}));m.load({wskey:this._wskeyInfo.get("id")},function(i){if(!i){w.one("#secret").setHTML(m.get("secret"));}else{errMsg=i.code==403?o.error.secretDenied:o.error.secretFailure;s.showErrorAlert(errMsg);}});C=this._wskeyInfo.get("params");w.one("#key").setHTML(this._wskeyInfo.get("id"));w.one("#status").setHTML(this._wskeyInfo.get("status"));w.one("#environment").setHTML(this._wskeyInfo.get("type"));var F=new Date(this._wskeyInfo.get("expirationDate"));w.one("#expirationDate").setHTML(d.Date.format(F,{format:"%m/%d/%Y"}));var E=d.Node.create("</div>");var j=w.one("#redirectUris");var v=C["redirect_uri"];this._redirectURICount=v.length;for(var A=1;A<=this._redirectURICount+1;A++){var l="redirectUri"+A;var h=l+"div";var y=d.Node.create('<div id="'+h+'">');j.appendChild(y);var r=d.Node.create('<label for="'+l+'">'+o.label.redirecturi+" "+A+"</label>");var t=d.Node.create('<input id="'+l+'" style="width: 200px"/>');var q=d.Node.create('<input type="button" value="Delete" id="delete"/>');var g=d.Node.create('<input type="button" value="Add" id="add"/>');var f=w.one("#"+h);if(A<=this._redirectURICount){f.appendChild(r);f.appendChild(t);w.one("#"+l).setAttribute("value",v[A-1]);if(!this._wskeyInfo.get("updateRedirectFlag")){w.one("#"+l).setAttribute("readonly",true);}else{f.appendChild(q);}}else{if(this._wskeyInfo.get("updateRedirectFlag")){f.appendChild(r);f.appendChild(g);}}j.appendChild(E);}w.one("#services").setHTML(this._formatServicesDetails(this._wskeyInfo.get("services")));w.one("#registryId").setHTML(this._wskeyInfo.get("registryID"));w.one("#oclcSymbol").setHTML(this._wskeyInfo.get("oclcSymbol"));w.one("#overrideInstitutions").setHTML(this._getServiceLevelParam(this._wskeyInfo.get("services"),"ctxOverRideInst"));w.one("#name").setAttribute("value",this._wskeyInfo.get("name"));var x=w.one("#corsDomains");var n=C["corsDomain"];this._corsDomainCount=n.length;for(var z=1;z<=n.length+1;z++){var u="corsDomain"+z;var D=u+"div";var B=d.Node.create('<div id="'+D+'">');x.appendChild(B);var r=d.Node.create('<label for="'+u+'">'+o.label.corsDomain+" "+z+"</label>");var t=d.Node.create('<input id="'+u+'" style="width: 200px"/>');var q=d.Node.create('<input type="button" value="Delete" id="delete"/>');var g=d.Node.create('<input type="button" value="Add" id="add"/>');var p=w.one("#"+D);if(z<=this._corsDomainCount){p.appendChild(r);p.appendChild(t);w.one("#"+u).setAttribute("value",n[z-1]);if(!this._wskeyInfo.get("updateRedirectFlag")){w.one("#"+u).setAttribute("readonly",true);}else{p.appendChild(q);}}else{if(this._wskeyInfo.get("updateRedirectFlag")){p.appendChild(r);p.appendChild(g);}}x.appendChild(E);}if(!this._wskeyInfo.get("updateNameFlag")){w.one("#name").setAttribute("readonly",true);}w.one(".save-btn").getDOMNode().hidden=!this._wskeyInfo.get("updateNameFlag")&&!this._wskeyInfo.get("updateRedirectFlag");w.one(".resetSecret-btn").getDOMNode().hidden=!this._wskeyInfo.get("updateSecretFlag");w.one(".blockWskey-btn").getDOMNode().hidden=!this._wskeyInfo.get("blockFlag")||F<=Date.now()||"ACTIVE"!==this._wskeyInfo.get("status");w.one(".activateWskey-btn").getDOMNode().hidden="DISABLED"!==this._wskeyInfo.get("status");}return this;},_onClickDeleteParamBtn:function(f){f.currentTarget.getDOMNode().closest("div").remove();},_onClickAddParamBtn:function(j){var h=this.get("container"),t=this.get("strings");var l=j.currentTarget.getDOMNode().closest("div").getAttribute("id");var p=d.Node.create("</div>");if(l.includes("redirectUri")){++this._redirectURICount;var f=h.one("#redirectUris");var m=t.label.redirecturi;var n=parseInt(this._redirectURICount)+1;var o="redirectUri"+this._redirectURICount;var i="redirectUri"+n;}else{++this._corsDomainCount;var f=h.one("#corsDomains");var m=t.label.corsDomain;var n=parseInt(this._corsDomainCount)+1;var o="corsDomain"+this._corsDomainCount;
var i="corsDomain"+n;}var q=i+"div";var v=d.Node.create('<div id="'+q+'">');var g=h.one("#"+o+"div");var s=d.Node.create('<label for="'+i+'">'+m+" "+n+"</label>");var r=d.Node.create('<input id="'+o+'" style="width: 200px"/>');var u=d.Node.create('<input type="button" value="Delete" id="delete"/>');var k=d.Node.create('<input type="button" value="Add" id="add"/>');j.currentTarget.getDOMNode().remove();g.appendChild(r);g.appendChild(u);f.appendChild(v);v.appendChild(s);v.appendChild(k);f.appendChild(p);},_deselectText:function(){if(document.selection){document.selection.empty();}else{if(window.getSelection){window.getSelection().removeAllRanges();}}},_hilightForCopy:function(g){var f;this._deselectText();if(document.selection){f=document.body.createTextRange();f.moveToElementText(g.currentTarget.getDOMNode());f.select();}else{if(window.getSelection){f=document.createRange();f.selectNode(g.currentTarget.getDOMNode());window.getSelection().addRange(f);}}},_onClickResetSecretBtn:function(){var i=this._app,h=this.get("container"),f=this.get("strings"),g=new d.WKM.ResetSecretModel();g.load({wskey:this._wskeyInfo.get("id")},function(j){if(!j){h.one("#secret").setHTML(g.get("secret"));}else{errMsg=j.code==403?f.error.resetSecretDenied:f.error.resetSecretFailure;i.showErrorAlert(errMsg);}});},_onClickBlockWskeyBtn:function(){var i=confirm("Are you sure, you want to block wskey!!!");if(i){var h=this.get("container"),f=this.get("strings");h.one(".blockWskey-btn").setAttribute("disabled","disabled");h.one(".save-btn").setAttribute("disabled","disabled");h.one(".resetSecret-btn").setAttribute("disabled","disabled");h.one(".activateWskey-btn").setAttribute("disabled","disabled");var g=new d.WKM.BlockWskeyModel();g.load({wskey:this._wskeyInfo.get("id")},function(k){if(!k){var j=f.error.blockWskeySuccess;h.alerts.add({success:[j]});}else{errMsg=k.code==403?f.error.blockWskeyDenied:f.error.blockWskeyFailure;app.showErrorAlert(errMsg);}});}},_onClickActivateWskeyBtn:function(){var f=confirm("Are you sure you want to re-activate this WSKey?");if(f){container.one(".blockWskey-btn").setAttribute("disabled","disabled");container.one(".save-btn").setAttribute("disabled","disabled");container.one(".resetSecret-btn").setAttribute("disabled","disabled");container.one(".activateWskey-btn").setAttribute("disabled","disabled");var g=new d.WKM.ActivateWskeyModel();g.load({wskey:this._wskeyInfo.get("id")},function(i){if(!i){var h=strings.error.activateWskeySuccess;container.alerts.add({success:[h]});}else{errMsg=i.code==403?strings.error.activateWskeyDenied:strings.error.activateWskeyFailure;app.showErrorAlert(errMsg);}});}},_onClickSaveBtn:function(){var g=this._wskeyInfo.get("params");var f=[];var n=0;for(var j=1;j<=this._redirectURICount;j++){var l=this.get("container").one("#redirectUri"+j+"div");if(l!=null){f[n]=this.get("container").one("#redirectUri"+j).get("value");n++;}}var o=[];var m=0;for(var h=1;h<=this._corsDomainCount;h++){var p=this.get("container").one("#corsDomain"+h+"div");if(p!=null){o[m]=this.get("container").one("#corsDomain"+h).get("value");m++;}}g["patch.redirect_uri"]=f;g["patch.name"]=[this.get("container").one("#name").get("value")];g["patch.corsDomain"]=o;this._wskeyInfo.after("save",this._onSaveSuccess,this);this._wskeyInfo.after("error",this._onSaveError,this);this._wskeyInfoList.create(this._wskeyInfo);},_onSaveError:function(f){this.handleError(f.response,"Error updating wskey");},_onSaveSuccess:function(f){location.reload();}},{ATTRS:{strings:{value:d.Intl.get(e)}}});},"@VERSION@",{requires:["base-view","datatype-date","wskeyinfo-model","wskeysecret-model","wskeyservice-model","wskeyrequest-model"],skinnable:true});
YUI.add("config-model",function(a){a.namespace("WKM").ConfigModel=a.Base.create("config-model",a.Model,[a.Platform.ModelSync.REST],{root:"/config"},{ATTRS:{opensocialUrl:{}}});},"@VERSION@",{requires:["model","cop-modelsync-extension"],skinnable:false});
YUI.add("waiting-overlay",function(c){var b=c.ClassNameManager.getClassName,d="waiting-overlay",a=b(d,"spinner");c.namespace("Platform").WaitingOverlay=c.Base.create("waiting-overlay",c.Overlay,[],{_cfg:null,_timer:null,initializer:function(e){this.plug(c.Plugin.OverlayModal);this.plug(c.Plugin.OverlayKeepaligned);this._cfg=e;},destructor:function(){this.unplug(c.Plugin.OverlayModal);this.unplug(c.Plugin.OverlayKeepaligned);},renderUI:function(){var e=this,f=this.get("boundingBox"),g;f.get("parentNode").addClass("waiting-overlay-node");if(this._cfg&&this._cfg.on&&this._cfg.on.cancel){g=c.Node.create('<div class="cancel">Cancel</div>');this.get("contentBox").append(g);g.on("click",function(){e._cfg.on.cancel.apply(e._cfg.context||e);});f.on("key",function(){e._cfg.on.cancel.apply(e._cfg.context||e);},"down:27");}},bindUI:function(){this.on("visibleChange",function(h){var g=this.get("boundingBox"),f=g.get("parentNode").one(".yui3-overlay-mask");if(h.newVal){this._timer=c.later(this.get("delay"),this,function(){f.setStyle("opacity",0.6);g.setStyle("visibility","visible");g.focus();});}else{if(this._timer!=null){this._timer.cancel();this._timer=null;}f.setStyle("opacity",0);g.setStyle("visibility","hidden");}});}},{ATTRS:{width:{value:150},zIndex:{value:1000},visible:{value:false},centered:{value:true},modal:{value:true},render:{value:false},bodyContent:{value:'<div class="'+a+'"></div>'},delay:{value:2000}}});},"@VERSION@",{requires:["gallery-overlay-extras","event-key"],skinnable:true});
YUI.add("user-inst-model",function(b){b.namespace("WKM").AddUserInstModel=b.Base.create("add-user-inst-model",b.Model,[b.Platform.ModelSync.REST],{root:"/addinst"},{ATTRS:{id:{},name:{}}});"use strict";var a;b.namespace("WKM").AddUserInstList=a=b.Base.create("add-user-inst-list",b.ModelList,[b.Platform.ModelSync.REST],{model:b.WKM.AddUserInstModel,getURL:function(e,d){var c=b.Platform.ModelSync.REST.prototype.getURL.apply(this,arguments);if(d.instId){c=c+"?instId="+d.instId;}return c;},parse:function(c){var d=a.superclass.parse.apply(this,arguments);if(d.institutions){return d.institutions;}return d;}},{});},"@VERSION@",{requires:["model","model-list","cop-modelsync-extension"],skinnable:false});
YUI.add("userinfo-model",function(b){b.namespace("WKM").UserInfoModel=b.Base.create("userinfo-model",b.Model,[b.Platform.ModelSync.REST],{root:"/userInfo",getURL:function(e,d){var c=b.Platform.ModelSync.REST.prototype.getURL.apply(this,arguments);if(d.view){c=c+"?view="+d.view;}return c;},},{ATTRS:{userType:{},institutions:{setter:function(d){var c=new b.WKM.InstitutionList();c.add(d);return c;}}}});"use strict";b.namespace("WKM").InstitutionModel=b.Base.create("institution-model",b.Model,[],{},{ATTRS:{id:{},name:{}}});"use strict";var a;b.namespace("WKM").InstitutionList=a=b.Base.create("institution-list",b.ModelList,[],{model:b.WKM.InstitutionModel},{});},"@VERSION@",{requires:["model","model-list","cop-modelsync-extension"],skinnable:false});
YUI.add("blockwskey-model",function(a){a.namespace("WKM").BlockWskeyModel=a.Base.create("blockwskey-model",a.Model,[a.Platform.ModelSync.REST],{root:"/blockWskey",getURL:function(d,c){var b=a.Platform.ModelSync.REST.prototype.getURL.apply(this,arguments);if(c.wskey){b=b+"?wskey="+c.wskey;}return b;}},{ATTRS:{message:{}}});},"@VERSION@",{requires:["model","cop-modelsync-extension"],skinnable:false});
YUI.add("activatewskey-model",function(a){a.namespace("WKM").ActivateWskeyModel=a.Base.create("activatewskey-model",a.Model,[a.Platform.ModelSync.REST],{root:"/activateWskey",getURL:function(d,c){var b=a.Platform.ModelSync.REST.prototype.getURL.apply(this,arguments);if(c.wskey){b=b+"?wskey="+c.wskey;}return b;}},{ATTRS:{message:{}}});},"@VERSION@",{requires:["model","cop-modelsync-extension"],skinnable:false});
YUI.add("wskey-app",function(c){var b,a=c.Lang,d="wskey-app";c.namespace("WKM").App=b=c.Base.create(d,c.App,[],{views:{request_wskey:{type:c.WKM.RequestWSKeyView},show_requests:{type:c.WKM.ShowRequestsView},manage_wskeys:{type:c.WKM.ManageWSKeysView},show_request:{type:c.WKM.ShowRequestView},manage_wskey:{type:c.WKM.ManageWSKeyView}},USER_TYPE_ELDAP:"ELDAP",USER_TYPE_SASI:"SASI",USER_TYPE_OCLC_SUPPORT:"OCLC_SUPPORT",VIEW_WSKEYS:"wskeys",VIEW_REQUESTS:"requests",VIEW_REQUEST_PROD:"create_prod_request",VIEW_REQUEST_SBOX:"create_sbox_request",_waitingOverlay:null,initializer:function(){var e=this,f=c.namespace("Platform.Env.App");f.contextPath=f.contextPath||e.get("root");c.after("manage-wskey",function(g){e.navigate(f.contextPath+"/keys/manage/"+g.id);},this);c.after("show-request",function(g){e.navigate(f.contextPath+"/requests/show/"+g.id);},this);e.dispatch();},destructor:function(){(new c.EventHandle(YObject.values(this._eventHandles))).detach();this._waitingOverlay&&this._waitingOverlay.remove(true);this._waitingOverlay=null;},render:function(){var f=c.config.doc,e=this.get("strings");b.superclass.render.apply(this,arguments);f.title=e.pageTitle;this._waitingOverlay=new c.Platform.WaitingOverlay().render(c.one("#wskey-app"));return this;},showErrorAlert:function(f){var e=this.get("viewContainer");if(!e.alerts){e.plug(c.Plugin.Alert);}e.alerts.clear();e.alerts.add(f,"error");},showWaiting:function(e){if(e){this._waitingOverlay.show();}else{this._waitingOverlay.hide();}},_gotoViewWithError:function(f,e){var g=this[f.route.callbacks[f.route.callbacks.length-1]];this.showErrorAlert(e);g.call(this,f);},findConfig:function(j,g,i){var h=new c.WKM.ConfigModel(),e=this.get("strings"),f=this;f._waitingOverlay.show();h.load(function(k){f._waitingOverlay.hide();if(k){f._gotoViewWithError(j,e.error.findConfig);}else{j.config=h;i();}});},findServices:function(k,g,i,h){var l=new c.WKM.WSKeyServiceList(),e=this.get("strings"),f=this,j=h?h:"all";f._waitingOverlay.show();l.load({type:j},function(m){f._waitingOverlay.hide();if(m){f._gotoViewWithError(k,e.error.loadServices);}else{k.serviceList=l;i();}});},findSandboxServices:function(g,e,f){this.findServices(g,e,f,"Sandbox");},findProductionServices:function(g,e,f){this.findServices(g,e,f,"Production");},findRequests:function(j,g,i){var h=new c.WKM.WSKeyRequestList(),e=this.get("strings"),f=this;f._waitingOverlay.show();h.load(function(k){f._waitingOverlay.hide();if(k){f._gotoViewWithError(j,e.error.loadRequests);}else{j.requestList=h;i();}});},_getAccessDeniedMsg:function(f){var e=this.get("strings");switch(f){case this.VIEW_WSKEYS:return e.error.accessDeniedWSKeys;case this.VIEW_REQUESTS:return e.error.accessDeniedRequests;case this.VIEW_REQUEST_PROD:return e.error.accessDeniedProdRequest;case this.VIEW_REQUEST_SBOX:return e.error.accessDeniedSboxRequest;default:return e.error.accessDenied;}},getUserInfoForWSKeys:function(g,e,f){this._getUserInfo(g,e,f,"wskeys");},getUserInfoForRequests:function(g,e,f){this._getUserInfo(g,e,f,"requests");},getUserInfoForCreateProdRequests:function(g,e,f){this._getUserInfo(g,e,f,"create_prod_request");},getUserInfoForCreateSboxRequests:function(g,e,f){this._getUserInfo(g,e,f,"create_sbox_request");},_getUserInfo:function(i,f,g,j){var l=new c.WKM.UserInfoModel(),k=this.get("strings"),m=this,h,e=this._getAccessDeniedMsg(j);m._waitingOverlay.show();l.load({view:j},function(n){m._waitingOverlay.hide();if(n){h=n.code==403?e:k.error.loadInsts;m._gotoViewWithError(i,h);}else{i.userInfo=l;g();}});},fillInstDropDown:function(f,e,h){var n=f.getDOMNode().getElementsByClassName("instDropdownSelect")[0],m=f.getDOMNode().getElementsByClassName("addInstBtnDiv")[0],j,k,l,g=new Map();for(j=0;j<n.options.length;j++){g.set(n.options[j].value,true);}for(j=0;j<e.size();j++){k=e.item(j);if(g.get(k.getAttrs().id)){continue;}l=document.createElement("option");l.value=k.getAttrs().id;if(k.getAttrs().name){l.innerHTML=k.getAttrs().name+" ("+k.getAttrs().id+")";}else{l.innerHTML=k.getAttrs().id;}n.appendChild(l);}if(h!=this.USER_TYPE_ELDAP&&h!=this.USER_TYPE_SASI){f.getDOMNode().getElementsByClassName("instDropdownDiv")[0].style.display="inline-block";}else{f.getDOMNode().getElementsByClassName("instDropdownDiv")[0].style.display="none";}if(m){m.style.display=h==this.USER_TYPE_OCLC_SUPPORT?"inline-block":"none";}},clearErrs:function(h,f,g){var e=this.get("viewContainer");if(e.alerts){e.alerts.clear();}g();},addInstToDropDown:function(e,j){var l=e.getDOMNode().getElementsByClassName("instDropdownSelect")[0],n=this.get("strings"),p,m=new c.WKM.AddUserInstList(),n=this.get("strings"),o=this,h,g,k=false,f=l.options.length==0?"":l.options[l.selectedIndex].value;p=prompt(n.addRegIdPrompt);if(!p){return;}o._waitingOverlay.show();m.load({instId:p},function(i){o._waitingOverlay.hide();if(i){o.showErrorAlert(n.error.cannotAddInst);}else{o.fillInstDropDown(e,m,o.USER_TYPE_OCLC_SUPPORT);for(g=0;g<l.options.length;g++){if(l.options[g].value==p){l.selectedIndex=g;if(j&&(f!=p)){j();}}}}});},requestProdWSKey:function(e,f){this._requestWSKey(e,true);},requestSboxWSKey:function(e){this._requestWSKey(e,false);},_requestWSKey:function(f,g){var e=this;strings=this.get("strings");this.showView("request_wskey",{userInfo:f.userInfo,opensocialUrl:f.config.get("opensocialUrl"),serviceList:f.serviceList,app:e,appStrings:strings,prodMode:g},this._setFocus);},showRequests:function(f){var e=this;strings=this.get("strings");this.showView("show_requests",{userInfo:f.userInfo,serviceList:f.serviceList,requestList:f.requestList,app:e,appStrings:strings},this._setFocus);},showRequest:function(e){this.showView("show_request",{serviceList:e.serviceList,request:e.requestList.getById(e.params.id)},this._setFocus);},findRequest:function(i,g,h){var j=new c.WKM.WSKeyRequestListById(),e=this.get("strings"),f=this;f._waitingOverlay.show();j.load({requestId:i.params.id},function(k){f._waitingOverlay.hide();if(k){errMsg=k.code==403?e.error.requestPermissionDenied:e.error.loadRequests;f._gotoViewWithError(i,errMsg);
}else{i.requestListById=j;h();}});},showRequestById:function(e){this.showView("show_request",{serviceList:e.serviceList,request:e.requestListById.item(0)},this._setFocus);},findWSKeys:function(j,g,i){var h=new c.WKM.WSKeyList(),e=this.get("strings"),f=this;f._waitingOverlay.show();h.load(function(k){f._waitingOverlay.hide();if(k){f._gotoViewWithError(j,e.error.loadWSKeys);}else{j.wskeyList=h;i();}});},findWSKeyById:function(j,g,i){var h=new c.WKM.WSKeyByIdList(),e=this.get("strings"),f=this;f._waitingOverlay.show();h.load({wskeyId:j.params.id},function(k){f._waitingOverlay.hide();if(k){errMsg=k.code==403?e.error.wskeyPermissionDenied:e.error.loadWSKeys;f._gotoViewWithError(j,errMsg);}else{j.wskeyByIdList=h;i();}});},manageWSKeys:function(g){var f=this,e=this.get("strings");this.showView("manage_wskeys",{userInfo:g.userInfo,serviceList:g.serviceList,wskeyList:g.wskeyList,app:f,appStrings:e},this._setFocus);},manageWSKey:function(f){var e=this;this.showView("manage_wskey",{serviceList:f.serviceList,wskey:f.wskeyByIdList.item(0),app:e},this._setFocus);},_setFocus:function(f){var e=f.get("container").one("input[autofocus]");if(e){e.focus();}}},{ATTRS:{routes:{value:[{path:"/",callback:["clearErrs","getUserInfoForWSKeys","findServices","findWSKeys","manageWSKeys"]},{path:"/keys/requestProd",callback:["clearErrs","getUserInfoForCreateProdRequests","findConfig","findProductionServices","requestProdWSKey"]},{path:"/keys/requestSbox",callback:["clearErrs","getUserInfoForCreateSboxRequests","findConfig","findSandboxServices","requestSboxWSKey"]},{path:"/requests/show",callback:["clearErrs","getUserInfoForRequests","findServices","findRequests","showRequests"]},{path:"/keys/manage",callback:["clearErrs","getUserInfoForWSKeys","findServices","findWSKeys","manageWSKeys"]},{path:"/requests/show/:id",callback:["clearErrs","findServices","findRequest","showRequestById"]},{path:"/keys/manage/:id",callback:["clearErrs","findServices","findWSKeyById","findWSKeys","manageWSKey"]}]},strings:{value:c.Intl.get(d)}}});},"@VERSION@",{requires:["app-base","handlebars","intl","request-wskey-view","show-requests-view","show-request-view","manage-wskeys-view","manage-wskey-view","config-model","wskeyservice-model","wskeyrequest-model","wskeyinfo-model","wskey-model","waiting-overlay","user-inst-model","userinfo-model","institution-model","blockwskey-model","activatewskey-model"],skinnable:true});
